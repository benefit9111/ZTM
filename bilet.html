<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilet ZTM Kielce</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;      /* без горизонтального скролу */
      background: #eaeaea;     /* фон навколо квитка */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Центруємо макет на екрані */
    .page {
      display: flex;
      justify-content: center;
    }

    /* Контейнер сторінки-квитка */
    .ticket {
      position: relative;      /* базовий контекст для абсолютного позиціювання .logo-stage */
      display: inline-block;
      line-height: 0;
      user-select: none;
    }

    /* Фон як <img> (тягнеться на 100% ширини контейнера) */
    .ticket img.bg {
      display: block;
      width: 100%;
      height: auto;
    }

    /* СЦЕНА анімації: поверх фону, позиції у % від фону */
    .logo-stage {
      position: absolute;
      top: 28%;            /* позиція по вертикалі від висоти фону */
      left: 5.4%;
      width: 89%;
      height: 47px;
      overflow: hidden;    /* обрізаємо за межами сцени */
      pointer-events: none;
      z-index: 1;
    }

    /* СТРІЧКА (дві копії логотипу підряд для безшовності) */
    .logo-track {
      position: absolute;
      top: 50%;
      display: flex;
      align-items: center;
      gap: 245px;                                /* за потреби можеш поставити, наприклад, 90px */
      transform: translateY(-50%);             /* центрування по Y */
      animation: marqueeCycle var(--duration, 10s) linear infinite;
      animation-direction: reverse;            /* зліва → направо */
      will-change: transform;
    }

    .logo-track img {
      height: 37px;         /* висота логотипу */
      flex: 0 0 auto;
      display: block;
    }

    /* Анімація: зсув рівно на ширину одного лого + gap (встановлюється з JS у --cycle) */
    @keyframes marqueeCycle {
      from { transform: translate(0, -50%); }
      to   { transform: translate(calc(var(--cycle, 0px) * -1), -50%); }
    }

    /* === DODANE: Overlay i bloki tekstowe (konfigurowalne pozycje) === */
    .overlay {
      position: absolute;
      inset: 0;        /* pełen obszar biletu */
      z-index: 2;      /* nad animacją logo */
      pointer-events: none;
      line-height: 1.2;
    }
    .text-block {
      position: absolute;
      /* Pozycje będą nadawane z atrybutów data-x / data-y (w %) */
      top: var(--y, 0%);
      left: var(--x, 0%);
      /* Punkt odniesienia (anchor) zależny od data-align: */
      transform: translate(-50%, -50%); /* domyślnie center */
      font-size: clamp(10px, var(--fs, 1.8vw), 26px);
      color: var(--color, #000);
      font-weight: var(--fw, 600);
      background: var(--bg, transparent);
      padding: 2px 6px;
      border-radius: 6px;
      white-space: nowrap;
      text-shadow: 0 1px 0 rgba(255,255,255,0.4);
    }
    /* Wyrównanie – zmieniamy transform X przez atrybut data-align */
    .text-block[data-align="left"]   { transform: translate(0%,   -50%); text-align: left; }
    .text-block[data-align="center"] { transform: translate(-50%, -50%); text-align: center; }
    .text-block[data-align="right"]  { transform: translate(-100%,-50%); text-align: right; }

    /* Opcjonalne warianty statusu (kolor obramowania przez tło wewnętrzne) */
    .text-block.status-ok   { box-shadow: 0 0 0 3px rgba(53,199,89,0.28) inset; }
    .text-block.status-warn { box-shadow: 0 0 0 3px rgba(255,204,0,0.35) inset; }
    .text-block.status-bad  { box-shadow: 0 0 0 3px rgba(255,59,48,0.35) inset; }
  </style>
</head>
<body>

  <div class="page">
    <div class="ticket">
      <!-- ФОН -->
      <img src="ztm.png" alt="tło biletu" class="bg">

      <!-- АНІМАЦІЯ ЛОГОТИПУ (безшовно, зліва → направо) -->
      <div class="logo-stage">
        <div class="logo-track">
          <img src="logo_ztm.png" alt="logo" />
          <img src="logo_ztm.png" alt="logo" />
        </div>
      </div>

      <!-- === DODANE: Nakładka z blokami tekstowymi (pozycje ustawiasz atrybutami data-*) === -->
      <div class="overlay" id="overlay">
        <!-- Numer boczny -->
        <div
          class="text-block"
          id="tb-num"
          data-x="8%" data-y="15%"
          data-align="left"
          data-fs="2.2vw"
          data-color="#0b3d91"
          data-fw="700"
        >Numer: —</div>

        <!-- Start lokalny -->
        <div
          class="text-block"
          id="tb-start-local"
          data-x="8%" data-y="25%"
          data-align="left"
          data-fs="1.6vw"
        >Start: —</div>

        <!-- Koniec lokalny -->
        <div
          class="text-block"
          id="tb-end-local"
          data-x="92%" data-y="25%"
          data-align="right"
          data-fs="1.6vw"
        >Ważny do: —</div>

        <!-- Status -->
        <div
          class="text-block"
          id="tb-status"
          data-x="50%" data-y="78%"
          data-align="center"
          data-fs="2.0vw"
          data-bg="rgba(255,255,255,0.65)"
          data-fw="700"
        >Status: —</div>

        <!-- Odliczanie do końca -->
        <div
          class="text-block"
          id="tb-countdown"
          data-x="50%" data-y="86%"
          data-align="center"
          data-fs="2.2vw"
          data-fw="800"
        >Pozostało: —</div>

        <!-- === NOWE: Czas od skasowania (licznik w górę) === -->
        <div
          class="text-block"
          id="tb-elapsed"
          data-x="8%" data-y="32%"
          data-align="left"
          data-fs="1.6vw"
          data-color="#111"
          data-fw="700"
        >Minęło: —</div>
      </div>
      <!-- === /DODANE === -->

    </div>
  </div>

  <!-- Скрипт обчислює точний «цикл» прокрутки: ширина одного лого + gap -->
  <script>
    function setMarqueeCycle() {
      const track = document.querySelector('.logo-track');
      if (!track) return;

      const firstImg = track.querySelector('img');
      if (!firstImg) return;

      // Поточні стилі (щоб взяти фактичний gap)
      const st   = getComputedStyle(track);
      const gap  = parseFloat(st.columnGap || st.gap) || 0;

      // Фактична ширина першого лого (з урахуванням поточного рендеру)
      const w = firstImg.getBoundingClientRect().width;

      // Цикл = ширина одного лого + gap
      const cycle = Math.ceil(w + gap);

      // Прокидаємо в CSS як змінну
      track.style.setProperty('--cycle', cycle + 'px');
    }

    // Рахуємо після повного завантаження (картинки теж), та при зміні розміру
    window.addEventListener('load', () => {
      setMarqueeCycle();
      window.addEventListener('resize', setMarqueeCycle);
    });
  </script>

  <!-- === DODANE: Skrypt do bloków tekstowych i odczytu parametrów === -->
  <script>
    // Ustawienie pozycji i stylu bloków na podstawie atrybutów data-*
    function applyTextBlockAttributes() {
      document.querySelectorAll('.text-block').forEach(el => {
        const { x, y, fs, color, fw, bg } = el.dataset;
        if (x) el.style.setProperty('--x', x);
        if (y) el.style.setProperty('--y', y);
        if (fs) el.style.setProperty('--fs', fs);
        if (color) el.style.setProperty('--color', color);
        if (fw) el.style.setProperty('--fw', fw);
        if (bg) el.style.setProperty('--bg', bg);
        // wyrównanie obsługuje atrybut data-align (CSS)
      });
    }

    // Parsowanie ISO -> Date z walidacją
    function parseIso(iso) {
      if (!iso) return null;
      const ms = Date.parse(iso);
      return Number.isNaN(ms) ? null : new Date(ms);
    }

    function toLocalPL(dt) {
      return dt.toLocaleString('pl-PL', {
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        day: '2-digit', month: '2-digit', year: 'numeric'
      });
    }

    function formatDown(msLeft) {
      if (msLeft <= 0) return '0m 00s';
      const totalSec = Math.floor(msLeft / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      return `${min}m ${String(sec).padStart(2, '0')}s`;
    }

    // Format w górę: hh:mm:ss (gdy > 59 min) lub mm:ss
    function formatUp(ms) {
      if (ms <= 0) return '0:00';
      const totalSec = Math.floor(ms / 1000);
      const h = Math.floor(totalSec / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function setStatusClass(el, msLeft) {
      el.classList.remove('status-ok', 'status-warn', 'status-bad');
      if (msLeft <= 0) {
        el.classList.add('status-bad');
      } else if (msLeft <= 2 * 60 * 1000) {
        el.classList.add('status-warn');
      } else {
        el.classList.add('status-ok');
      }
    }

    function initTicketOverlay() {
      applyTextBlockAttributes();

      const params = new URLSearchParams(window.location.search);
      const numStr     = params.get('num');
      const tsStartStr = params.get('ts_start'); // ISO: teraz - 1 min (ustawiane w index.html)
      const tsEndStr   = params.get('ts_end');   // ISO: teraz + 59 min (ustawiane w index.html)

      const elNum       = document.getElementById('tb-num');
      const elStartLoc  = document.getElementById('tb-start-local');
      const elEndLoc    = document.getElementById('tb-end-local');
      const elStatus    = document.getElementById('tb-status');
      const elCountdown = document.getElementById('tb-countdown');
      const elElapsed   = document.getElementById('tb-elapsed');

      // Numer
      const num = Number.parseInt(numStr ?? '', 10);
      elNum.textContent = Number.isFinite(num) ? `Numer: ${num}` : 'Numer: —';

      // Czas
      const startDt = parseIso(tsStartStr);
      const endDt   = parseIso(tsEndStr);

      elStartLoc.textContent = startDt
        ? `Start: ${toLocalPL(startDt)}`
        : 'Start: —';

      elEndLoc.textContent = endDt
        ? `Ważny do: ${toLocalPL(endDt)}`
        : 'Ważny do: —';

      // Liczniki + status
      if (endDt) {
        const update = () => {
          const now = Date.now();

          // w dół do końca
          const msLeft = endDt.getTime() - now;
          setStatusClass(elStatus, msLeft);
          if (msLeft <= 0) {
            elStatus.textContent = 'Status: bilet wygasł';
            elCountdown.textContent = 'Pozostało: 0m 00s';
          } else if (msLeft <= 2 * 60 * 1000) {
            elStatus.textContent = 'Status: kończy się ważność';
            elCountdown.textContent = 'Pozostało: ' + formatDown(msLeft);
          } else {
            elStatus.textContent = 'Status: bilet ważny';
            elCountdown.textContent = 'Pozostało: ' + formatDown(msLeft);
          }

          // w górę od skasowania (ts_start)
          if (startDt) {
            const msUp = Math.max(0, now - startDt.getTime());
            elElapsed.textContent = 'Minęło: ' + formatUp(msUp);
          } else {
            elElapsed.textContent = 'Minęło: —';
          }
        };

        update();
        const timerId = setInterval(() => {
          update();
          if (Date.now() >= endDt.getTime()) clearInterval(timerId);
        }, 1000);
      } else {
        elStatus.textContent = 'Status: —';
        elCountdown.textContent = 'Pozostało: —';
        elElapsed.textContent = startDt ? 'Minęło: ' + formatUp(Date.now() - startDt.getTime()) : 'Minęło: —';
        setStatusClass(elStatus, -1);
      }
    }

    // Odpal po pełnym załadowaniu (po obrazkach, żeby procenty liczyły się względem końcowych wymiarów)
    window.addEventListener('load', initTicketOverlay);
    // I ewentualnie po zmianie rozmiaru – pozycje w % i tak są responsywne
    window.addEventListener('resize', applyTextBlockAttributes);
  </script>
  <!-- === /DODANE === -->

</body>
</html>
``
